name: Build Single Tinygrad Model and Push

on:
  workflow_call:
    inputs:
      upstream_branch:
        description: 'Upstream commit to build from'
        required: true
        type: string
      custom_name:
        description: 'Custom name for the model (no date, only name)'
        required: false
        type: string
      json_version:
        description: 'driving_models version number to update (e.g. 5 for driving_models_v5.json)'
        required: true
        type: string
      artifact_suffix:
        description: 'Suffix for artifact name'
        required: false
        type: string
        default: ''
      bypass_push:
        description: 'Bypass pushing to models repo (used by build-all)'
        required: false
        default: true
        type: boolean
      is_20hz:
        description: 'Is this a 20Hz model'
        required: false
        default: true
        type: boolean
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: 'Upstream commit to build from'
        required: true
        type: string
      custom_name:
        description: 'Custom name for the model (no date, only name)'
        required: false
        type: string
      json_version:
        description: 'driving_models version number to update (e.g. 5 for driving_models_v5.json)'
        required: true
        type: string
      model_folder:
        description: 'Model folder'
        type: choice
        default: 'None'
        options:
          - None
          - Simple Plan Models
          - Space Lab Models
          - TR Models
          - DTR Models
          - Custom Merge Models
          - FOF series models
          - Other
      custom_model_folder:
        description: 'Custom model folder name (if "Other" selected)'
        required: false
        type: string
      generation:
        description: 'Model generation'
        required: false
        type: string
      version:
        description: 'Minimum selector version'
        required: false
        type: string
      is_20hz:
        description: 'Is this a 20Hz model'
        required: false
        type: boolean
        default: true
env:
  JSON_FILE: driving_models_v${{ inputs.json_version }}.json

jobs:
  build_model:
    uses: ./.github/workflows/hoofpilot-build-model.yaml
    with:
      upstream_branch: ${{ inputs.upstream_branch }}
      custom_name: ${{ inputs.custom_name || inputs.upstream_branch }}
      is_20hz: ${{ inputs.is_20hz }}
      artifact_suffix: ${{ inputs.artifact_suffix }}
    secrets: inherit

  publish_model:
    if: ${{ !inputs.bypass_push && !cancelled() }}
    concurrency:
      group: models-repo-push
      cancel-in-progress: false
    needs: build_model
    runs-on: ubuntu-latest
    steps:
      - name: Install git-lfs
        run: sudo apt-get install -y git-lfs

      - name: Checkout models repo
        uses: actions/checkout@v4
        with:
          repository: hoofpilot/models
          ref: master
          path: models
          ssh-key: ${{ secrets.CI_MODELS_REPO_PRIVATE_KEY }}
          lfs: false

      - name: Configure LFS credentials for HuggingFace
        working-directory: models
        run: |
          git lfs install
          git config credential.helper store
          printf "https://user:%s@huggingface.co\n" "${{ secrets.HF_TOKEN }}" >> ~/.git-credentials

      - name: Ensure models directory exists
        run: |
          mkdir -p models/models
          if [ ! -f "models/$JSON_FILE" ]; then
            echo "Creating initial JSON file models/$JSON_FILE"
            echo '{"version": ${{ inputs.json_version }}, "bundles": []}' > "models/$JSON_FILE"
          fi

      - name: Download artifact name file
        uses: actions/download-artifact@v4
        with:
          name: artifact-name-${{ inputs.custom_name || inputs.upstream_branch }}
          path: artifact_name

      - name: Read artifact name
        id: read-artifact-name
        run: |
          ARTIFACT_NAME=$(cat artifact_name/artifact_name.txt)
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Download and extract model artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.read-artifact-name.outputs.artifact_name }}
          path: output

      - name: Remove unwanted files
        run: |
          find output -type f -name 'dmonitoring_model_tinygrad.pkl' -delete
          find output -type f -name 'dmonitoring_model.onnx' -delete

      - name: Copy model files into category/short_name subfolder
        run: |
          SHORT_NAME=$(python3 -c "import json; print(json.load(open('output/metadata.json'))['short_name'].upper())")
          FOLDER="${{ inputs.model_folder }}"
          if [ "$FOLDER" = "Other" ]; then
            FOLDER="${{ inputs.custom_model_folder }}"
          fi
          if [ "$FOLDER" = "None" ] || [ -z "$FOLDER" ]; then
            FOLDER="${SHORT_NAME} Models"
          fi
          MODEL_DIR="models/models/${FOLDER}/${SHORT_NAME}"
          mkdir -p "$MODEL_DIR"
          find output -maxdepth 1 -type f \( -name '*.pkl' -o -name '*.onnx' -o -name '*.dlc' -o -name '*.thneed' \) | while IFS= read -r f; do
            cp "$f" "$MODEL_DIR/"
            echo "Copied $(basename "$f") -> models/${FOLDER}/${SHORT_NAME}/"
          done
          if [ -f output/metadata.json ]; then
            cp output/metadata.json "$MODEL_DIR/metadata.json"
            echo "Copied metadata.json -> models/${FOLDER}/${SHORT_NAME}/"
          fi

      - name: Pull latest changes from models repo
        run: |
          cd models
          GIT_LFS_SKIP_SMUDGE=1 git pull origin master

      - name: Run json_parser.py to update JSON
        run: |
          FOLDER="${{ inputs.model_folder }}"
          if [ "$FOLDER" = "Other" ]; then
            FOLDER="${{ inputs.custom_model_folder }}"
          fi
          ARGS=""
          if [ "$FOLDER" != "None" ] && [ -n "$FOLDER" ]; then
            ARGS="$ARGS --model-folder \"$FOLDER\""
          fi
          [ -n "${{ inputs.generation }}" ] && ARGS="$ARGS --generation \"${{ inputs.generation }}\""
          [ -n "${{ inputs.version }}" ] && ARGS="$ARGS --version \"${{ inputs.version }}\""
          eval python3 models/json_parser.py \
            --json-path "models/$JSON_FILE" \
            --recompiled-dir "models/models" \
            --sort-by-date \
            $ARGS

      - name: Push updated models to GitHub and LFS objects to HuggingFace
        run: |
          cd models
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git checkout master
          cp "$JSON_FILE" driving_models.json
          git add models/
          git add "$JSON_FILE"
          git add driving_models.json
          git commit -m "Update $JSON_FILE and models from single build" || echo "No changes to commit"
          git push origin master
