name: Build and push all tinygrad models

on:
  workflow_dispatch:
    inputs:
      set_min_version:
        description: 'Minimum selector version required for the models (see helpers.py or readme.md)'
        required: true
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      json_version: ${{ steps.get-json.outputs.json_version }}
      json_file: ${{ steps.get-json.outputs.json_file }}
      model_matrix: ${{ steps.set-matrix.outputs.model_matrix }}
      tinygrad_ref: ${{ steps.get-tinygrad-ref.outputs.tinygrad_ref }}
    steps:
      - name: Checkout hoofpilot repo
        uses: actions/checkout@v4
        with:
          repository: hoofpilot/hoofpilot
          path: hoofpilot
          submodules: recursive

      - name: Get tinygrad_repo ref
        id: get-tinygrad-ref
        run: |
          cd hoofpilot
          export PYTHONPATH=$(pwd)
          ref=$(python3 hoofpilot/models/tinygrad_ref.py)
          echo "tinygrad_ref=$ref" >> $GITHUB_OUTPUT
          echo "tinygrad_ref is $ref"

      - name: Checkout models repo
        uses: actions/checkout@v4
        with:
          repository: hoofpilot/models
          ref: master
          path: models
          ssh-key: ${{ secrets.CI_MODELS_REPO_PRIVATE_KEY }}
          lfs: false

      - name: Get next JSON version to use (from GitHub models repo)
        id: get-json
        run: |
          cd models
          latest=$(ls driving_models_v*.json 2>/dev/null | sed -E 's/.*_v([0-9]+)\.json/\1/' | sort -n | tail -1 || echo "0")
          next=$((latest+1))
          json_file="driving_models_v${next}.json"
          if [ -f "driving_models_v${latest}.json" ]; then
            cp "driving_models_v${latest}.json" "$json_file"
          else
            echo '{"version": '$next', "bundles": []}' > "$json_file"
          fi
          echo "json_file=$json_file" >> $GITHUB_OUTPUT
          echo "json_version=$((next+0))" >> $GITHUB_OUTPUT
          echo "SRC_JSON_FILE=driving_models_v${latest}.json" >> $GITHUB_ENV

      - name: Extract tinygrad models
        id: set-matrix
        working-directory: models
        run: |
          jq -c '[.bundles[] | select(.runner=="tinygrad") | {ref, display_name: (.display_name | gsub(" \\([^)]*\\)"; "")), is_20hz, folder: .overrides.folder}]' "$(basename "${SRC_JSON_FILE}")" > matrix.json
          echo "model_matrix=$(cat matrix.json)" >> $GITHUB_OUTPUT

      - name: Push new JSON to models repo
        run: |
          cd models
          git pull origin master
          git add "$(basename ${{ steps.get-json.outputs.json_file }})"
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git commit -m "Add ${{ steps.get-json.outputs.json_file }} for build-all" || echo "No changes to commit"
          git push origin master

  get_and_build:
    needs: [setup]
    strategy:
      matrix:
        model: ${{ fromJson(needs.setup.outputs.model_matrix) }}
      fail-fast: false
    uses: ./.github/workflows/build-single-tinygrad-model.yaml
    with:
      upstream_branch: ${{ matrix.model.ref }}
      custom_name: ${{ matrix.model.display_name }}
      json_version: ${{ needs.setup.outputs.json_version }}
      is_20hz: ${{ matrix.model.is_20hz }}
    secrets: inherit

  retry_failed_models:
    needs: [setup, get_and_build]
    runs-on: ubuntu-latest
    if: ${{ needs.setup.result != 'failure' && !cancelled() }}
    outputs:
      retry_matrix: ${{ steps.set-retry-matrix.outputs.retry_matrix }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: model-*
          path: output

      - id: set-retry-matrix
        run: |
          echo '${{ needs.setup.outputs.model_matrix }}' > matrix.json
          built=(); while IFS= read -r line; do built+=("$line"); done < <(
            find output -maxdepth 1 -name 'model-*' -printf "%f\n" | sed -E 's/^model-//' | sed -E 's/-[0-9]+$//' | sed -E 's/ \([^)]*\)//' | awk '{gsub(/^ +| +$/, ""); print}'
          )
          jq -c --argjson built "$(printf '%s\n' "${built[@]}" | jq -R . | jq -s .)" \
            'map(select(.display_name as $n | ($built | index($n | gsub("^ +| +$"; "")) | not)))' matrix.json > retry_matrix.json
          echo "retry_matrix=$(cat retry_matrix.json)" >> $GITHUB_OUTPUT

  retry_get_and_build:
    needs: [setup, get_and_build, retry_failed_models]
    if: ${{ needs.get_and_build.result == 'failure' || (needs.retry_failed_models.outputs.retry_matrix != '[]' && needs.retry_failed_models.outputs.retry_matrix != '') }}
    strategy:
      matrix:
        model: ${{ fromJson(needs.retry_failed_models.outputs.retry_matrix) }}
      fail-fast: false
    uses: ./.github/workflows/build-single-tinygrad-model.yaml
    with:
      upstream_branch: ${{ matrix.model.ref }}
      custom_name: ${{ matrix.model.display_name }}
      json_version: ${{ needs.setup.outputs.json_version }}
      artifact_suffix: -retry
      is_20hz: ${{ matrix.model.is_20hz }}
    secrets: inherit

  publish_models:
    name: Publish models sequentially
    needs: [setup, get_and_build, retry_failed_models, retry_get_and_build]
    if: ${{ !cancelled() && (needs.get_and_build.result != 'failure' || needs.retry_get_and_build.result == 'success' || (needs.retry_failed_models.outputs.retry_matrix != '[]' && needs.retry_failed_models.outputs.retry_matrix != '')) }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        model: ${{ fromJson(needs.setup.outputs.model_matrix) }}
    env:
      JSON_FILE: ${{ needs.setup.outputs.json_file }}
      ARTIFACT_NAME_INPUT: ${{ matrix.model.display_name }}
      MODEL_FOLDER: ${{ matrix.model.folder }}
    steps:
      - name: Install git-lfs
        run: sudo apt-get install -y git-lfs

      - name: Checkout models repo
        uses: actions/checkout@v4
        with:
          repository: hoofpilot/models
          ref: master
          path: models
          ssh-key: ${{ secrets.CI_MODELS_REPO_PRIVATE_KEY }}
          lfs: false

      - name: Configure LFS credentials for HuggingFace
        working-directory: models
        run: |
          git lfs install
          git config credential.helper store
          printf "https://user:%s@huggingface.co\n" "${{ secrets.HF_TOKEN }}" >> ~/.git-credentials

      - name: Ensure models directory exists
        run: |
          mkdir -p models/models
          if [ ! -f "models/$JSON_FILE" ]; then
            echo "Warning: JSON file models/$JSON_FILE does not exist, will be created"
          fi

      - name: Download artifact name file
        uses: actions/download-artifact@v4
        with:
          name: artifact-name-${{ env.ARTIFACT_NAME_INPUT }}
          path: artifact_name

      - name: Read artifact name
        id: read-artifact-name
        run: |
          ARTIFACT_NAME=$(cat artifact_name/artifact_name.txt)
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Download model artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.read-artifact-name.outputs.artifact_name }}
          path: output

      - name: Remove unwanted files
        run: |
          find output -type f -name '*.onnx' -delete
          find output -type f -name 'big_*.pkl' -delete
          find output -type f -name 'dmonitoring_model_tinygrad.pkl' -delete

      - name: Copy model files into category/short_name subfolder
        run: |
          SHORT_NAME=$(python3 -c "import json; print(json.load(open('output/metadata.json'))['short_name'].upper())")
          MODEL_DIR="models/models/${MODEL_FOLDER}/${SHORT_NAME}"
          mkdir -p "$MODEL_DIR"
          find output -maxdepth 1 -type f \( -name '*.pkl' -o -name '*.dlc' -o -name '*.thneed' \) | while IFS= read -r f; do
            cp "$f" "$MODEL_DIR/"
            echo "Copied $(basename "$f") -> models/${MODEL_FOLDER}/${SHORT_NAME}/"
          done
          if [ -f output/metadata.json ]; then
            cp output/metadata.json "$MODEL_DIR/metadata.json"
            echo "Copied metadata.json -> models/${MODEL_FOLDER}/${SHORT_NAME}/"
          fi

      - name: Pull latest changes from models repo
        run: |
          cd models
          GIT_LFS_SKIP_SMUDGE=1 git pull origin master

      - name: Update JSON
        run: |
          ARGS=""
          [ -n "${{ inputs.set_min_version }}" ] && ARGS="$ARGS --set-min-version \"${{ inputs.set_min_version }}\""
          ARGS="$ARGS --sort-by-date"
          ARGS="$ARGS --tinygrad-ref \"${{ needs.setup.outputs.tinygrad_ref }}\""
          eval python3 models/json_parser.py \
            --json-path "models/$JSON_FILE" \
            --recompiled-dir "models/models" \
            $ARGS

      - name: Push updated models to GitHub and LFS objects to HuggingFace
        run: |
          cd models
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git checkout master
          cp "$(basename $JSON_FILE)" driving_models.json
          git add models/
          git add "$(basename $JSON_FILE)"
          git add driving_models.json
          git commit -m "Update $(basename $JSON_FILE) and models from build-all" || echo "No changes to commit"
          git push origin master
